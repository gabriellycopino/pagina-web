var HU=HU||{};HU.SSO=HU.SSO||{};(function(_container){"use strict";_container.baseUrl=HU.SSO.baseUrl||"https://passport.hurb.com";_container.logonUrl=HU.SSO.baseUrl+"/checkPoint";_container.logoutUrl=HU.SSO.baseUrl+"/checkPoint/logout";_container.csfrUrl=HU.SSO.csfrUrl||"https://www.hurb.com/pay/csfr";_container.userDataUrl=HU.SSO.userDataUrl||"https://myaccountapi.hurb.com/v1/users/basic";_container.key=HU.SSO.key||"5485c36d3148f319854ebeb9";_container.lang=HU.SSO.lang||"pt_BR";_container.csfr=HU.SSO.csfr||"000000";_container.googleId=HU.SSO.googleId||"294303068320-77emisj9tuqr5iek35k6hlg5filksaeo.apps.googleusercontent.com";_container.facebookId=HU.SSO.facebookId||173460426152579;_container.hasFacebookSDK=function(){return window&&window.FB;}
_container.loadFacebookSDK=function(){if(!_container.hasFacebookSDK()){var sFB=document.createElement("script");sFB.src='https://connect.facebook.net/'+_container.lang+'/sdk'+(window.localStorage&&localStorage.getItem('fbDebug')?'/debug':'')+'.js';sFB.defer=true;sFB.async=true;document.head.appendChild(sFB);window.fbAsyncInit=function(){FB.init({appId:_container.facebookId,autoLogAppEvents:true,xfbml:true,version:'v8.0'});FB.AppEvents.logPageView();};}}
_container.__onload=function(){_container.__init();_container.loginGoogleYolo().then(undefined,function(){});_container.loadFacebookSDK();};_container.__init=function(){_container.logonUrl=HU.SSO.baseUrl+"/checkPoint";_container.logoutUrl=HU.SSO.baseUrl+"/checkPoint/logout";_container.myAccountStatus="https://myaccountapi.hurb.com/v1/users/status";};_container.loginGoogleYolo=function(){_container.__init();return waitGoogleAccounts().then(function(result){if(!result.ready){throw new Error('Google Yolo not ready');}
return result;}).then(function(result){if(!hasGoogleAccounts()){throw new Error('Google yolo not ready');}
return result;}).then(function(result){return _container.isUserLoggedIn().then(function(data){if(data.isLoggedIn){throw new Error('User already logged in');}
return result;});}).then(function(){return new Promise(function(resolve,reject){window.google.accounts.id.initialize({client_id:HU.SSO.googleId,auto_select:false,scope:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email",],callback:resolve});window.google.accounts.id.prompt(function(notification){if(notification.getSkippedReason()==="user_cancel"){fireGoogleAnalytics("send",{hitType:"event",eventCategory:"Login",eventAction:"click_login_fechar",eventLabel:"one_tap_google"});if(window.hum){window.hum("event","one_tap_google","click_login_fechar");}}
if(notification.isNotDisplayed()&&notification.getNotDisplayedReason()==="opt_out_or_no_session"){fireGoogleAnalytics("send",{hitType:"event",eventCategory:"Login",eventAction:"no_google_account",eventLabel:"one_tap_google"});if(window.hum){window.hum("event","one_tap_google","no_google_account");}}
if(notification.isSkippedMoment()){reject(new Error("Google yolo skipped"));}
if(notification.isNotDisplayed()){reject(new Error("Google yolo not displayed"));}});});}).then(function(credentialResponse){fireGoogleAnalytics("send",{hitType:"event",eventCategory:"Login",eventAction:"click_login",eventLabel:"one_tap_google"});sendEventGa4('login',{method:'One_tap_google'});if(window.mixpanel){var user_id=credentialResponse.clientId;var l10nExists=HU.env&&HU.env.l10n;window.mixpanel.track('Login',{method:'One_tap_google',pos:l10nExists&&l10nExists.pos,locale:l10nExists&&l10nExists.locale,user_id:user_id,user_sso_exists:Boolean(user_id)});window.mixpanel.identify(user_id);window.mixpanel.people.set_once({lifetime_value:0,purchase_volume:0});}
if(window.hum){window.hum("event","one_tap_google","click_login");}
return loginByGoogleToken(credentialResponse.credential);});function waitGoogleAccounts(){if(!hasGoogleAccounts()&&document&&window&&window.navigator){var s=document.createElement("script");s.src="https://accounts.google.com/gsi/client?onload=onGoogleLibraryLoad";s.defer=true;s.async=true;document.head.appendChild(s);}
return new Promise(function(resolve){var finalized=false;var intervalId=undefined;var intervalCounter=0;if(hasGoogleAccounts()){finalize(true);return;}
window.onGoogleLibraryLoad=function(){finalize(true);};intervalId=setInterval(function(){intervalCounter++;if(hasGoogleAccounts()){finalize(true);}else if(intervalCounter>=7){finalize(false);}},1000);function finalize(isReady){if(finalized)return;finalized=true;if(intervalId){clearInterval(intervalId);}
resolve({ready:isReady});}});}
function hasGoogleAccounts(){return window.google&&window.google.accounts;}};_container.logon=function(login,password,persistCookie,csfr,destinationUrl){_container.__init();csfr=csfr||HU.SSO.csfr;persistCookie=persistCookie||true;var data={frm_login:login,frm_password:password,frm_persistCookie:persistCookie,csfr:csfr,destiantionUrl:destinationUrl||false,appKey:HU.SSO.key,lang:HU.SSO.lang};return login(_container.logonUrl,data,destinationUrl);}
_container.logout=function(destinationUrl){_container.__init();return request({responseType:'json',url:HU.SSO.logoutUrl+(destinationUrl?"?redirUrl="+destinationUrl:''),timeout:5000,withCredentials:true}).then(function(data){var paths=data.domainsToLogout.map(function(domain){return'//'+domain+data.pathLogout;});return loadScripts(paths).then(undefined,function(error){if(typeof error==='object'&&error.message==='Paths is empty'){return;}
throw error;}).then(function(){return data;});}).then(function(data){if(destinationUrl){window.location=destinationUrl;}else{dispatchSSOEvent('HU.SSO.userLoggedOut');};return data;}).then(undefined,function(error){if(console&&console.warn){console.warn("Can't logout the user");}
dispatchSSOEvent('HU.SSO.userLogoutError');throw error;});}
_container.generateCsfr=function(options){return jQuery.ajax(_container.csfrUrl,options);}
_container.isUserLoggedIn=function(){return request({responseType:'json',url:_container.myAccountStatus,timeout:10000,withCredentials:true});};_container.getLoggedInUser=function(options){return request({responseType:'json',url:_container.userDataUrl,withCredentials:true});};_container.loginFacebook=function(sso_app_id,csfr,destinationUrl,signupParams){_container.__init();sso_app_id=sso_app_id||_container.key;var fbOptions={scope:'public_profile,email'};FB.login(function(response){if(!response.authResponse){if(console&&console.warn){console.warn('User cancelled login or did not fully authorize.');}
dispatchSSOEvent('HU.SSO.actionFail');throw new Error("Facebook login not authorized");}
_container.facebookCallback(response.authResponse,csfr,sso_app_id,destinationUrl,signupParams);},fbOptions);};_container.facebookCallback=function(authResponse,csfr,sso_app_id,destinationUrl,signupParams){var params={fields:"id,first_name,last_name,email,picture{url}",redirect:"false"};FB.api("/me","GET",params,function(response){if(!response||response.error){throw new Error("Error getting user info from Facebook SDK");}
ssoLoginByFacebook(authResponse,response,csfr,sso_app_id,destinationUrl,signupParams);});sendEventGa4('login',{method:'Facebook'});if(window.mixpanel){var user_id=authResponse.userID;var l10nExists=HU.env&&HU.env.l10n;window.mixpanel.track('Login',{method:'Facebook',pos:l10nExists&&l10nExists.pos,locale:l10nExists&&l10nExists.locale,user_id:user_id,user_sso_exists:Boolean(user_id)});window.mixpanel.identify(user_id);window.mixpanel.people.set_once({lifetime_value:0,purchase_volume:0});}
function ssoLoginByFacebook(authResponse,userResponse,csfr,sso_app_id,destinationUrl,signupParams){var user=_container.buildUserData();user.email=userResponse.email;user.firstName=userResponse.first_name;user.lastName=userResponse.last_name;user.picture=userResponse.picture.data.url;user.facebook={id:userResponse.id};var csfr=csfr||HU.SSO.csfr;copyTo(user.extra,{fbToken:authResponse.accessToken,appId:sso_app_id,csfr:csfr});copyTo(user.extra,signupParams);return request({url:_container.logonUrl+'?appKey='+_container.key+'&ping=1',timeout:10000}).then(function(data){_container.csfr=data;user.extra.csfr=data;return login(_container.logonUrl+'/facebook',user,destinationUrl);});}}
_container.loginGoogle=function(signupParams){_container.__init();window.google.accounts.oauth2.initTokenClient({client_id:_container.googleId,ux_mode:'popup',scope:'https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',callback:handleTokenResponse,error_callback:handlePromptError}).requestAccessToken();function handleTokenResponse(tokenAccess){var access_token=tokenAccess.access_token;return request({url:'https://www.googleapis.com/oauth2/v3/userinfo',responseType:'json',headers:{'Authorization':'Bearer '+access_token}}).then(function(data){fireGoogleAnalytics("send",{hitType:"event",eventCategory:"Login",eventAction:"click_login",eventLabel:"button_google"});if(window.hum){window.hum("event","button_google","click_login");};var userData={'email':data.email,'firstName':data.given_name,'lastName':data.family_name,'password':undefined,'picture':data.picture,'locale':data.locale,'integrations':[{'id':data.sub,'platform':'google'}]};return loginByGoogleToken(access_token,userData,signupParams);},function(error){console.error(error);});};function handlePromptError(error){dispatchSSOEvent('HU.SSO.actionFail');};};_container.__onload();function fireGoogleAnalytics(event,options){if(typeof ga==="function")ga(event,options);}
function sendEventGa4(eventName,options){if(typeof gtag==='function')gtag('event',eventName,options);}
function copyTo(target,params){target=target||{};if(params&&Object.keys(params).length>0){for(var i=0;i<Object.keys(params).length;i+=1){var key=Object.keys(params)[i];target[key]=params[key];}}
return target;}
_container.buildUserData=function(){var userData={};userData.extra={appKey:_container.key,csfr:_container.csfr,};userData.locale=HU&&HU.env&&HU.env.l10n&&HU.env.l10n.locale?HU.env.l10n.locale:getNavigatorLang();userData.currency=HU&&HU.env&&HU.env.l10n&&HU.env.l10n.currency?HU.env.l10n.currency:"";userData.timeZone=(new Date().getTimezoneOffset()/60)*-1;return userData;}
function getNavigatorLang(){var lang=undefined;if(Array.isArray(navigator.languages)&&navigator.languages.length>0){lang=navigator.languages[0];}else if(navigator.userLanguage){lang=navigator.userLanguage;}else{lang=navigator.language;}
return lang;};function login(url,data,destinationUrl){return request({method:'POST',responseType:'json',url:url,data:JSON.stringify(data),timeout:10000,withCredentials:true}).then(function(data){if(window.hum&&data.hul){window.hum("login",data.hul);}
return loadScripts(data.tokens).then(undefined,function(error){if(typeof error==='object'&&error.message==='Paths is empty'){return;}
throw error;}).then(function(){if(destinationUrl){window.location=destinationUrl;}else{if(console&&console.info){console.info('HU.SSO: User logged in');}
dispatchSSOEvent('HU.SSO.userLoggedIn');};return data;});}).then(undefined,function(error){if(console&&console.warn){console.warn("Can't login the user");}
dispatchSSOEvent('HU.SSO.userLogonError');throw error;});}
function loginByGoogleToken(googleToken,userInfos,extraInfos){userInfos=userInfos||{};extraInfos=extraInfos||{};var userData=_container.buildUserData();copyTo(userData,userInfos);copyTo(userData.extra,extraInfos);userData.extra.gyToken=googleToken;return request({url:_container.logonUrl+'?appKey='+_container.key+'&ping=1',timeout:10000}).then(function(data){_container.csfr=data;userData.extra.csfr=data;return login(_container.logonUrl+'/googleYolo',userData);});}
function dispatchSSOEvent(eventType,eventData){if(jQuery){jQuery(window).triggerHandler(eventType,eventData);}}
function request(opts){return new Promise(function(resolve,reject){opts.method=opts.method||'GET';var xhr=new XMLHttpRequest();var data=opts.data;if(data&&typeof data==='object'){data=JSON.stringify(data);}
if(opts.responseType){xhr.responseType=opts.responseType;}
if(opts.withCredentials!==undefined){xhr.withCredentials=opts.withCredentials;}
if(opts.timeout!==undefined){xhr.timeout=opts.timeout;}
xhr.open(opts.method,opts.url);if(opts.headers){Object.keys(opts.headers).forEach(function(key){xhr.setRequestHeader(key,opts.headers[key]);});}
xhr.onload=function(){if(this.status>=200&&this.status<300){resolve(xhr.response);}else{reject({status:this.status,response:xhr.response});}};xhr.onerror=function(){reject({status:this.status,response:xhr.response});};xhr.send(data);});}
function loadScripts(paths){return new Promise(function(resolve){if(!paths){throw new Error("Paths is undefined");}
if(paths.length===0){throw new Error("Paths is empty");}
var total=paths.length;var loaded=0;paths.map(function(path){var s=document.createElement('script');s.src=path;s.onload=function(){onLoad();};document.head.appendChild(s);});function onLoad(){loaded++;check();}
function check(){if(loaded===total){resolve();}}})};})(HU.SSO);
